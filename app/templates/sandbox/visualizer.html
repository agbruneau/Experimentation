{% extends "base.html" %}

{% block extra_head %}
<script src="https://d3js.org/d3.v7.min.js"></script>
<script src="/static/js/flow-visualizer.js"></script>
{% endblock %}

{% block content %}
<div class="h-full flex flex-col">
    <!-- Header avec infos session -->
    <div class="flex items-center justify-between mb-4">
        <div>
            <h1 class="text-2xl font-bold text-white" id="scenario-title">Visualiseur de Flux</h1>
            <p class="text-gray-400 text-sm" id="scenario-description"></p>
        </div>
        <div class="flex items-center gap-4">
            <span class="text-sm text-gray-400">Ã‰tape <span id="current-step">1</span> / <span id="total-steps">6</span></span>
            <button onclick="resetScenario()" class="px-3 py-1 bg-gray-700 hover:bg-gray-600 rounded text-sm">
                <i data-lucide="refresh-cw" class="w-4 h-4 inline"></i> Reset
            </button>
        </div>
    </div>

    <!-- Zone principale -->
    <div class="flex-1 flex gap-4 min-h-0">
        <!-- Instructions -->
        <div class="w-80 bg-gray-800 rounded-lg border border-gray-700 flex flex-col">
            <div class="p-4 border-b border-gray-700">
                <h2 class="font-semibold text-white">Instructions</h2>
            </div>
            <div class="flex-1 overflow-auto p-4">
                <div id="instruction-content" class="text-gray-300">
                    <p class="text-gray-500 italic">Chargement...</p>
                </div>
            </div>
            <div class="p-4 border-t border-gray-700 flex gap-2">
                <button onclick="showHint()" class="flex-1 px-3 py-2 bg-gray-700 hover:bg-gray-600 rounded text-sm">
                    ðŸ’¡ Indice
                </button>
                <button onclick="validateStep()" class="flex-1 px-3 py-2 bg-green-600 hover:bg-green-700 rounded text-sm font-medium">
                    Valider âœ“
                </button>
            </div>
        </div>

        <!-- Visualiseur D3 -->
        <div class="flex-1 bg-gray-800 rounded-lg border border-gray-700 flex flex-col">
            <div class="p-4 border-b border-gray-700 flex items-center justify-between">
                <h2 class="font-semibold text-white">Flux d'intÃ©gration</h2>
                <div class="flex items-center gap-2">
                    <button onclick="zoomIn()" class="p-1 bg-gray-700 hover:bg-gray-600 rounded">
                        <i data-lucide="zoom-in" class="w-4 h-4"></i>
                    </button>
                    <button onclick="zoomOut()" class="p-1 bg-gray-700 hover:bg-gray-600 rounded">
                        <i data-lucide="zoom-out" class="w-4 h-4"></i>
                    </button>
                    <button onclick="resetZoom()" class="p-1 bg-gray-700 hover:bg-gray-600 rounded">
                        <i data-lucide="maximize" class="w-4 h-4"></i>
                    </button>
                </div>
            </div>
            <div class="flex-1 relative" id="visualizer-container">
                <!-- Le SVG sera crÃ©Ã© par FlowVisualizer -->
            </div>
            <!-- Timeline -->
            <div class="p-4 border-t border-gray-700">
                <div class="flex items-center gap-4">
                    <button onclick="playReplay()" class="p-2 bg-gray-700 hover:bg-gray-600 rounded">
                        <i data-lucide="play" class="w-4 h-4"></i>
                    </button>
                    <div class="flex-1 h-2 bg-gray-700 rounded-full overflow-hidden">
                        <div id="timeline-progress" class="h-full bg-blue-500 transition-all" style="width: 0%"></div>
                    </div>
                    <span class="text-sm text-gray-400" id="timeline-time">0ms</span>
                </div>
            </div>
        </div>

        <!-- Console -->
        <div class="w-96 bg-gray-800 rounded-lg border border-gray-700 flex flex-col">
            <div class="p-4 border-b border-gray-700 flex items-center justify-between">
                <h2 class="font-semibold text-white">Console</h2>
                <button onclick="clearConsole()" class="text-xs text-gray-400 hover:text-white">
                    Effacer
                </button>
            </div>
            <div id="console-output" class="flex-1 overflow-auto p-4 font-mono text-sm space-y-1">
                <div class="text-gray-500">// Console prÃªte</div>
            </div>
            <div class="p-4 border-t border-gray-700">
                <div class="flex gap-2">
                    <input type="text" id="console-input" placeholder="Entrez une commande..."
                           class="flex-1 bg-gray-900 border border-gray-700 rounded px-3 py-2 text-sm focus:outline-none focus:border-blue-500"
                           onkeypress="if(event.key==='Enter')executeCommand()">
                    <button onclick="executeCommand()" class="px-3 py-2 bg-blue-600 hover:bg-blue-700 rounded text-sm">
                        ExÃ©cuter
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    let sessionId = null;
    let scenario = null;
    let currentStep = 1;
    let visualizer = null;

    // Initialisation avec le nouveau FlowVisualizer
    function initVisualizer() {
        visualizer = initFlowVisualizer('visualizer-container', {
            width: document.getElementById('visualizer-container').clientWidth,
            height: document.getElementById('visualizer-container').clientHeight
        });

        // Ajouter les services de base
        const services = [
            { id: 'gateway', name: 'API Gateway', pillar: 'applications', type: 'gateway' },
            { id: 'quote', name: 'Quote Engine', pillar: 'applications' },
            { id: 'policy', name: 'Policy Admin', pillar: 'applications' },
            { id: 'claims', name: 'Claims', pillar: 'applications' },
            { id: 'billing', name: 'Billing', pillar: 'events' },
            { id: 'notif', name: 'Notifications', pillar: 'events' },
            { id: 'broker', name: 'Event Bus', pillar: 'events', type: 'broker' }
        ];

        services.forEach(s => visualizer.addNode(s));

        // Ajouter les liens
        const links = [
            { source: 'gateway', target: 'quote', pillar: 'applications' },
            { source: 'gateway', target: 'policy', pillar: 'applications' },
            { source: 'gateway', target: 'claims', pillar: 'applications' },
            { source: 'policy', target: 'broker', pillar: 'events' },
            { source: 'broker', target: 'billing', pillar: 'events' },
            { source: 'broker', target: 'notif', pillar: 'events' }
        ];

        links.forEach(l => visualizer.addLink(l));

        // Connecter au SSE
        visualizer.connectSSE('/events/stream');
    }

    // Animation d'un message utilisant le nouveau visualiseur
    function animateMessage(from, to, data, duration = 500) {
        if (visualizer) {
            visualizer.animateMessage(from, to, data, { duration });
        }
        logToConsole(`â†’ ${from} â†’ ${to}: ${JSON.stringify(data)}`, 'message');
    }

    // Console
    function logToConsole(message, type = 'info') {
        const console = document.getElementById('console-output');
        const colors = {
            info: 'text-gray-400',
            success: 'text-green-400',
            error: 'text-red-400',
            message: 'text-blue-400',
            event: 'text-orange-400'
        };
        const timestamp = new Date().toLocaleTimeString();
        console.innerHTML += `<div class="${colors[type]}">[${timestamp}] ${message}</div>`;
        console.scrollTop = console.scrollHeight;
    }

    function clearConsole() {
        document.getElementById('console-output').innerHTML = '<div class="text-gray-500">// Console effacÃ©e</div>';
    }

    async function executeCommand() {
        const input = document.getElementById('console-input');
        const command = input.value.trim();
        if (!command) return;

        logToConsole(`> ${command}`, 'info');
        input.value = '';

        try {
            const response = await fetch(`/api/sandbox/sessions/${sessionId}/execute?command=${encodeURIComponent(command)}`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ args: {} })
            });
            const data = await response.json();
            logToConsole(data.output, data.success ? 'success' : 'error');
        } catch (e) {
            logToConsole('Erreur: ' + e.message, 'error');
        }
    }

    // Validation d'Ã©tape
    async function validateStep() {
        if (!sessionId) return;

        try {
            const response = await fetch(`/api/sandbox/sessions/${sessionId}/validate`, {
                method: 'POST'
            });
            const data = await response.json();

            if (data.completed) {
                logToConsole('ðŸŽ‰ ScÃ©nario terminÃ© !', 'success');
                showToast('FÃ©licitations ! ScÃ©nario terminÃ©.', 'success');
            } else {
                currentStep = data.current_step;
                updateStepDisplay();
                logToConsole(`âœ“ Ã‰tape ${data.previous_step} validÃ©e`, 'success');
            }
        } catch (e) {
            logToConsole('Erreur validation: ' + e.message, 'error');
        }
    }

    function updateStepDisplay() {
        document.getElementById('current-step').textContent = currentStep;
        if (scenario && scenario.steps[currentStep - 1]) {
            const step = scenario.steps[currentStep - 1];
            document.getElementById('instruction-content').innerHTML = `
                <div class="mb-4">
                    <span class="px-2 py-1 bg-blue-600/30 text-blue-400 rounded text-xs">Ã‰tape ${step.id}</span>
                </div>
                <h3 class="font-semibold text-white mb-2">${step.title}</h3>
                <p class="text-gray-300">${step.instruction}</p>
            `;
        }
    }

    function showHint() {
        showToast('ðŸ’¡ Indice: Suivez les instructions Ã©tape par Ã©tape', 'info');
    }

    function playReplay() {
        logToConsole('â–¶ Replay en cours...', 'info');
        if (visualizer) {
            visualizer.replayTimeline(1);
        }
        // Animation de la timeline
        let progress = 0;
        const interval = setInterval(() => {
            progress += 5;
            document.getElementById('timeline-progress').style.width = progress + '%';
            document.getElementById('timeline-time').textContent = (progress * 10) + 'ms';
            if (progress >= 100) clearInterval(interval);
        }, 100);
    }

    function resetScenario() {
        location.reload();
    }

    // Zoom functions utilisant le nouveau visualiseur
    function zoomIn() {
        if (visualizer && visualizer.svg) {
            visualizer.svg.transition().call(visualizer.zoom.scaleBy, 1.3);
        }
    }

    function zoomOut() {
        if (visualizer && visualizer.svg) {
            visualizer.svg.transition().call(visualizer.zoom.scaleBy, 0.7);
        }
    }

    function resetZoom() {
        if (visualizer) {
            visualizer.resetZoom();
        }
    }

    // Charger la session
    async function loadSession() {
        const params = new URLSearchParams(window.location.search);
        sessionId = params.get('session');

        if (sessionId) {
            try {
                const response = await fetch(`/api/sandbox/sessions/${sessionId}`);
                const data = await response.json();
                scenario = data.scenario;
                currentStep = data.current_step;

                document.getElementById('scenario-title').textContent = scenario.title;
                document.getElementById('scenario-description').textContent = scenario.description;
                document.getElementById('total-steps').textContent = scenario.steps.length;

                updateStepDisplay();
                logToConsole(`Session ${sessionId} chargÃ©e - ${scenario.title}`, 'success');
            } catch (e) {
                logToConsole('Erreur chargement session: ' + e.message, 'error');
            }
        }
    }

    // Initialisation
    document.addEventListener('DOMContentLoaded', () => {
        initVisualizer();
        loadSession();
        lucide.createIcons();
    });
</script>
{% endblock %}
